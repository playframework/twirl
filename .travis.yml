version: ~> 1.0
import: scala/scala-dev:travis/default.yml

git:
  depth: false # Avoid sbt-dynver not seeing the tag

language: scala

scala:
  - 2.12.14
  - 2.13.6
  - 3.0.1

env:
  matrix:
    - ADOPTOPENJDK=8
    - ADOPTOPENJDK=11

script:
  - sbt ++$TRAVIS_SCALA_VERSION test

jobs:
  include:
    - name: "Validations"
      script: sbt validateCode +mimaReportBinaryIssues
      env: ADOPTOPENJDK=8

    - name: "Plugin tests"
      script: sbt plugin/test plugin/scripted
      env: ADOPTOPENJDK=8

    - name: "Validate documentation"
      script: scripts/validate-docs.sh
      env: ADOPTOPENJDK=8

    - stage: release
      name: "Release artifacts to Sonatype"
      script: sbt ci-release
      env: ADOPTOPENJDK=8

stages:
  - name: test
  - name: release
    if: tag IS present

notifications:
  slack:
    secure: lrBEBp00Fwr3T72GXK+eOaQVNy34QT+OBcJanr/WCVoD3kgt+L5hkEZ3iS9B7pDd26vMBcUGBb5kM8Z5QGo48gvbLUFgRtaTU00EBoTXbUPDIqlaMkuxdF+TN7GgS7yZKnKIInj54e7o1QaJ4R/I/Atw81kUJr0PNzMU0hfg6VU=

# safelist
branches:
  only:
    - main
    - /^\d+\.\d+(\.\d+)?(-\S*)?$/
